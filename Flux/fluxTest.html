<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>React Test</title>
  </head>
  <body>
    <div id="example"></div>
    <script src="../build/jquery.min.js"></script>
    <script src="../build/react.js"></script>
    <script src="../build/react-dom.js"></script>
    <script src="../build/browser.min.js"></script>
    <script type="text/babel">
      import {Dispatcher} from 'flux';
      import {EventEmitter} from 'events';
      import * as assign from 'object-assign';
      var AppDispatcher = new Dispatcher();
      var ListStore = assign({}, EventEmitter.prototype, {
        items: [],

        getAll: function () {
          return this.items;
        },

        addNewItemHandler: function (text) {
          this.items.push(text);
        },

        emitChange: function () {
          this.emit('change');
        },

        addChangeListener: function(callback) {
          this.on('change', callback);
        },

        removeChangeListener: function(callback) {
          this.removeListener('change', callback);
        }
      });

      AppDispatcher.register(function (action) {
        switch(action.actionType) {
          case 'ADD_NEW_ITEM':
            ListStore.addNewItemHandler(action.text);
            ListStore.emitChange();
            break;
          default:
                // no op
        }
      })
      var ButtonActions = {
        addNewItem: function (text) {
          AppDispatcher.dispatch({
            actionType: 'ADD_NEW_ITEM',
            text: text
          });
        },
      };
      var MyButton = function(props) {
        var items = props.items;
        var itemHtml = items.map(function (listItem, i) {
          return <li key={i}>{listItem}</li>;
        });

        return <div>
          <ul>{itemHtml}</ul>
          <button onClick={props.onClick}>New Item</button>
        </div>;
      };
      var MyButtonController = React.createClass({
        getInitialState: function () {
          return {
            items: ListStore.getAll()
          };
        },

        componentDidMount: function() {
          ListStore.addChangeListener(this._onChange);
        },

        componentWillUnmount: function() {
          ListStore.removeChangeListener(this._onChange);
        },

        _onChange: function () {
          this.setState({
            items: ListStore.getAll()
          });
        },

        createNewItem: function (event) {
          ButtonActions.addNewItem('new item');
        },

        render: function() {
          return <MyButton
                  items={this.state.items}
                  onClick={this.createNewItem}
          />;
        }
      });
      ReactDOM.render(
              <MyButtonController/>,
              document.querySelector('#example')
      );
    </script>
  </body>
</html>
